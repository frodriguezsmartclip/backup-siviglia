<style>
    .remove, .NewItemString .add {
        font-family:'IcoMoon'
    }
    .remove:before {

    }
    .description:empty {display:none}
    .NewItemString .add {
        margin-left: 5px;
        margin-top: 6px;
        color: green;
    }
    .add:before {
        font-family:"Ionicons";
        content: '\f359';
        font-size: 20px;
    }
    .remove {
        font-family: 'IcoMoon';
    }
    input[type=checkbox]{
        width:15px !important;
        height:15px !important;
    }
    .ContainerType {}

    .ContainerType .ContainerType .containerLabel {
        min-width:150px !important;
        font-size:12px
    }
    .containerInput {
        display: table-cell;
    }
    .dictionaryInput {
        min-width:200px
    }
    .removebutton:after {
        font-family:"Ionicons";
        font-size: 16px;
        content: "\f128";
        color: darkred;
        margin-top: 7px;
        margin-left: 5px;
    }
    .navbar-form {
        padding:0px !important;
    }
</style>
<script>

    Siviglia.Utils.buildClass(
        {
            context: 'Siviglia.inputs.jqwidgets',
            classes: {
                Factory:{
                    methods:{
                        getInput:function(type,params)
                        {
                            var stype=type.type;
                            if(!Siviglia.isset(params))
                                params={};
                            if(Siviglia.isset(params.controller))
                                type.setController(params.controller);
                            var dv=$('<div></div>');
                            var p=params || {};
                            p.type=type;
                            switch(stype)
                            {
                                case "Integer":
                                case "String":
                                {
                                    if(type.hasSource())
                                        stype="ComboBox";
                                }break;
                            }
                            var stack = new Siviglia.Path.ContextStack();
                            var instance=new Siviglia.inputs.jqwidgets[stype](
                                "Siviglia.inputs.jqwidgets."+stype,
                                p,
                                {},
                                dv,
                                stack
                            );
                            instance.__build();
                            return instance;
                        }
                    }
                },
                Form:{
                  inherits:"Siviglia.UI.Expando.View,Factory",
                  destruct:function(){
                      if(this.__widgets)
                      {
                          for(var k in this.__widgets)
                              this.__widgets.destruct();
                      }
                  }  ,
                  methods:
                      {
                          preInitialize:function(params)
                          {
                              var definition=params.definition;
                              var value=params.value;
                              this.__types={};
                              this.__widgets={};
                              this.__typeFactory=Siviglia.types.TypeFactory;
                              value=Siviglia.issetOr(value,{});
                              for(var k in definition)
                              {
                                  this[k]=this.__typeFactory.getType(definition[k],value[k]);
                                  this[k].setController(this);
                                  var p=Siviglia.issetOr(definition["INPUT"],{});
                                  p.controller=this;
                                  this.__widgets[k]=this.getInput(this[k],p);
                              }
                          }
                      }
                },
                BaseInput: {
                    inherits: "Siviglia.UI.Expando.View,Siviglia.Dom.EventManager",

                    methods: {
                        preInitialize: function (params) {
                            this.errored = false;
                            this.controller = this.parentView;
                            this.changing=false;
                            this.errorMessage = "";
                            this.type = params.type;
                            this.helpMessage = Siviglia.issetOr(this.type.definition.HELP, null);
                            this.hasHelpMessage = (this.helpMessage != null ? true : false);
                            this.inputParams = Siviglia.issetOr(params.inputParams, {});
                        },
                        initialize: function (params) {
                            var opts = this.getDefaultInputOptions();
                            for (var k in this.inputParams)
                                opts[k] = this.inputParams[k];
                            this.createInput(opts);
                            this.inputNode[this.getJqxWidgetName()]('theme', 'light');
                            var m = this;
                            this.inputNode.on("change", function () {
                                if (m.changing)
                                    return;
                                m.changing=true;
                                try {
                                    if (m.validate())
                                        m.type.setValue(m.getValue());
                                }catch(e)
                                {
                                    this.showError(
                                        Siviglia.i18n.es.base.getErrorFromJsException(e)
                                    );
                                }
                                m.changing=false;

                            })
                            if (this.type.is_set()) {
                                var toSet = this.type.getValue();
                                this._setInputValue(toSet);
                            }
                        },
                        detach:function()
                        {
                            this.Widget$detach();
                            this.type.removeListeners(this);
                        },

                        getDefaultInputOptions: function () {
                            return {};
                        },
                        createInput: function (options) {

                            return this.callInp(options)
                        },
                        _setInputValue: function (toSet) {
                            this.changing = true;
                            this.inputNode[this.getJqxWidgetName()]('val', toSet);
                            this.changing = false;
                        },
                        getValue: function () {
                            return this.inputNode[this.getJqxWidgetName()]('val');
                        },
                        validate: function () {
                            var val = this.getValue();
                            try {
                                this.type.validate(val);
                                this.clearErrors();
                                return true;
                            } catch (e) {
                                this.showError(
                                    Siviglia.i18n.es.base.getErrorFromJsException(e)
                                );
                            }
                            return false;
                        },
                        showError: function (message) {
                            var d = new Date();
                            this.tooltip = this.inputNode.jqxTooltip(
                                {
                                    name: d + d.getMilliseconds(),
                                    animationShowDelay: 'fast',
                                    autoHide: false,
                                    closeOnClick: false,
                                    position: 'right'
                                });
                            this.inputNode.jqxTooltip({content: message});
                            this.inputNode.jqxTooltip("open");
                            this.inputNode.addClass("errored");
                        },
                        clearErrors: function () {
                            if (this.tooltip)
                                this.inputNode.jqxTooltip('destroy');
                            this.inputNode.removeClass("errored");
                            /*if(this.validator)
                             ths.validator.hide();*/
                        },
                        getJqxWidgetName: function () {
                            return "jqxInput";
                        },
                        callInp: function (obj) {
                            return this.inputNode[this.getJqxWidgetName()](obj);
                        },
                        disable: function () {
                            this.callInp({disabled: true});
                        },
                        enable: function () {
                            this.callInp({disabled: false});
                        },
                        on:function(event,callback)
                        {
                            this.inputNode.on(event,callback);
                        }
                    }
                },
                String: {
                    /*
                     disabled	Boolean	false
                     dropDownWidth	Number/String	null
                     displayMember	String	""
                     height	Number/String	null
                     items	Number	8
                     minLength	Number	1
                     maxLength	Number	null
                     opened	Boolean	false
                     placeHolder	String	""
                     popupZIndex	Number	20000
                     query	String	""
                     renderer	function	null
                     rtl	Boolean	false
                     searchMode	String	'default'
                     source	Array, function	[]
                     theme	String	''
                     valueMember	String	""
                     width
                     */
                    inherits: "Siviglia.inputs.jqwidgets.BaseInput",
                    methods: {
                        getDefaultInputOptions: function () {
                            var d = this.type.definition;
                            var opts = {};
                            if (d.MINLENGTH)
                                opts.minLength = d.MINLENGTH;
                            if (d.MAXLENGTH)
                                opts.maxLength = d.MAXLENGTH;
                            return opts;
                        }

                    }
                },
                Enum: {
                    inherits: 'BaseInput',
                    methods: {
                        getDefaultInputOptions: function () {
                            var finalOpts = [];
                            var d = this.type.definition;
                            for (var k = 0; k < d.VALUES.length; k++) {
                                var c = d.VALUES[k];
                                var label, value;
                                label = value = c;
                                if (typeof c == "object") {
                                    label = c.LABEL;
                                    value = c.VALUE;
                                }
                                finalOpts.push(
                                    {
                                        html: '<div tabIndex=0 style="padding:1px">' + label + '</div>',
                                        label: label,
                                        value: value
                                    }
                                )
                            }
                            var opts = {
                                source: finalOpts, //finalOpts,
                                placeHolder: 'Seleccionar',
                                autoComplete: false,
                                height: 25,
                                displayMember: "label",
                                valueMember: "value",
                                width: 200, minLength: 0
                            };
                            return opts;
                        },
                        getJqxWidgetName: function () {
                            return "jqxComboBox";
                        }
                    }
                },
                Integer: {
                    inherits: 'BaseInput',
                    methods: {
                        /* {value: null,
                         decimal: 0,
                         min: -99999999,
                         max: 99999999,
                         width: 200,
                         validationMessage: "Invalid value",
                         height: 25, textAlign: "right", readOnly: false,
                         promptChar: "_",
                         decimalDigits: 2,
                         decimalSeparator: ".", groupSeparator: ",", groupSize: 3, symbol: "", symbolPosition: "left", digits: 8, negative: false, negativeSymbol: "-", disabled: false, inputMode: "advanced", spinButtons: false, spinButtonsWidth: 18, spinButtonsStep: 1, autoValidate: true, spinMode: "advanced", enableMouseWheel: true, touchMode: "auto", rtl: false, events: ["valueChanged", "textchanged", "mousedown", "mouseup", "keydown", "keyup", "keypress", "change"], aria: {"aria-valuenow": {name: "decimal", type: "number"}, "aria-valuemin": {name: "min", type: "number"}, "aria-valuemax": {name: "max", type: "number"}, "aria-disabled": {name: "disabled", type: "boolean"}}, invalidArgumentExceptions: ["invalid argument exception"]};
                         */
                        getDefaultInputOptions: function () {

                            return {decimalDigits: 0};
                        },
                        getJqxWidgetName: function () {
                            return "jqxNumberInput";
                        }
                    }
                },
                Decimal: {
                    inherits: 'BaseInput',
                    methods: {
                        getDefaultInputOptions: function () {
                            var d = this.type.definition;
                            return {decimalDigits: d.NDECIMALS, digits: d.NINTEGERS};
                        },
                        getJqxWidgetName: function () {
                            return "jqxNumberInput";
                        }
                    }
                },
                Text: {
                    inherits: 'BaseInput',
                    methods: {
                        initialize: function (params) {
                            var m = this;
                            $(document).ready(function () {
                                m.BaseInput$initialize(params);
                            });
                        },
                        getDefaultInputOptions: function () {
                            return {
                                height: "400px",
                                width: '800px'
                            };
                        },
                        getJqxWidgetName: function () {
                            return "jqxEditor";
                        }

                    }
                },
                AutoIncrement: {
                    inherits: 'Siviglia.UI.Expando.View,Siviglia.Dom.EventManager',
                    methods: {
                        preInitialize: function (params) {
                            this.value = params.type.getValue();
                        },
                        initialize: function (params) {
                        },
                        getValue: function () {
                            return this.type.getValue();
                        }
                    }
                },
                Boolean: {
                    inherits: 'BaseInput',
                    methods: {
                        getDefaultInputOptions: function () {
                            return {width: 20, height: 20};
                        },
                        getJqxWidgetName: function () {
                            return "jqxCheckBox";
                        },
                        _setInputValue: function (value) {
                            if (value == null || value == "0" || value == "false" || value == false)
                                this.inputNode.jqxCheckBox({checked: false});
                            else
                                this.inputNode.jqxCheckBox({checked: true});
                        },
                        getValue: function () {
                            return this.inputNode.val() ? "1" : "0";
                        }
                    }
                },
                ComboBox: {
                    inherits: 'BaseInput',

                    methods: {
                        preInitialize: function (params) {
                            this.preprocessParams(params);
                            this.source=null;
                            this.dataBinding=false;
                            this.BaseInput$preInitialize(params);
                        },
                        initialize: function (params) {

                            var opts = this.getDefaultInputOptions();
                          //  for (var k in this.inputParams)
                          //      opts[k] = this.inputParams[k];
                            this.createInput(opts);
                            this.inputNode[this.getJqxWidgetName()]('theme', 'light');
                            var m = this;
                            this.inputNode.on("select", function (ev) {
                                if(!m.dataBinding) {
                                    if (ev.args) {
                                        m.changing = true;
                                        var newVal = ev.args.item.value;
                                        if (newVal == -1) {
                                            m.type.setValue(null);

                                        } else {
                                            if (m.validate())
                                                m.type.setValue(m.getValue());
                                        }
                                        m.changing = false;
                                    }
                                }
                                else
                                {
                                    m._setInputValue(null);
                                }
                            })


                            if (this.disabled) {

                                this.disable();
                                return;
                            }
                            else
                                this.refresh();

                        },
                        detach:function()
                        {
                            this.BaseInput$detach();
                            if(this.source)
                                this.source.removeListeners(this);
                        },
                        preprocessParams: function (params) {
                            this.type=params.type;
                            var s=this.type.getSource();
                            this.labelField = s.getLabelField();
                            this.valueField = s.getValueField();
                        },
                        getValue: function () {
                            var v = this.inputNode.jqxComboBox('val');
                            if (v == '')
                                v = null;
                            return v;
                        },
                        getJqxWidgetName: function () {
                            return "jqxComboBox";
                        },
                        getDefaultInputOptions: function () {
                            var self = this;
                            this.dataSource = {
                                localdata: [],
                                datatype: "array"
                            };
                            this.dataAdapter = new $.jqx.dataAdapter(self.dataSource);
                            return {
                                source: this.dataAdapter,
                                openDelay: 200,
                                autoComplete: true,
                                autoBind: false,
                                minLength: 1,
                                remoteAutoComplete: true,
                                displayMember: this.getLabelField(),
                                valueMember: this.getValueField(),
                                autoDropDownHeight: true,
                                width: 200,
                                height: 25,
                                placeHolder:Siviglia.issetOr(this.inputParams["placeholder"],"--Select"),
                                search: function (str) {
                                    self.searchString = str;
                                    self.refresh();
                                }
                            };
                        },
                        _setInputValue: function (toSet) {
                            if (this.changing)
                                return;
                            this.changing = true;
                            if(toSet==null)
                            {

                                this.inputNode.jqxComboBox('selectItem',-1);
                                this.inputNode.jqxComboBox('val','');
                                this.type.setValue(null);

                            }
                            else {
                                var item = this.inputNode.jqxComboBox('getItemByValue', toSet);
                                if (item) {
                                    this.inputNode.jqxComboBox('selectItem', item);
                                    this.inputNode.jqxComboBox('val', item.label);
                                }
                            }
                            this.changing = false;
                        },
                        getLabelField: function () {
                            return this.labelField;
                        },
                        getValueField: function () {
                            return this.valueField;
                        },
                        buildParameters: function () {
                            var obj = {
                                "search": this.searchString
                            };
                            if (this.sourceParameters) {
                                for (var k in this.sourceParameters) {
                                    obj[k] = this.sourceParameters[k];
                                }
                            }
                            return obj;
                        },
                        refresh: function () {
                            if (this.disabled)
                                return;
                            var params = this.buildParameters();
                            this.getSource(params);

                        },
                        getSource: function (params) {
                            if(this.source==null) {
                                //this.type.clear();
                                var plainCtx = new Siviglia.Path.BaseObjectContext(this.controller, "*");
                                var s = this.type.getSource();
                                s.addContext(plainCtx);
                                s.addListener("CHANGE", this, "onSourceChanged");

                                this.source=s;
                            }
                            this.source.fetch();
                            return this.source;

                        },
                        onSourceChanged:function(evName,data)
                        {
                            var self=this;
                            var s=this.type.source.getValueField();
                            self.dataSource.localdata = data.value==null?[]:data.value;
                            // La llamada a dataBind genera un problema en select anidados:
                            // Si existen dos select anidados, S1 y S2, ocurre lo siguiente:
                            // Inicialmente, S1 y S2 est√°n en blanco. Se selecciona un item de S1. S2 sigue en blanco.
                            // Se selecciona ahora un valor de S2.
                            // Posteriormente, se cambia el valor de S1. El valor de S2 ahora deberia ponerse en blanco,
                            // ya que su valor dependia del valor antiguo de S1.
                            // En vez de eso, lo que ocurre es que al llamar a dataBind, se genera un evento "select", y se
                            // autoselecciona el primer valor del nuevo set de datos asignado a S2.
                            // Por eso, se marca que estamos haciendo el databind, para controlarlo en el gestor de eventos.
                            this.dataBinding=true;
                            self.dataAdapter.dataBind();
                            this.dataBinding=false;
                            if (self.type.is_set()) {
                                var toSet = self.type.getValue();
                                var it = self.inputNode.jqxComboBox('getItemByValue', toSet);
                                if (it) {
                                    self._setInputValue(toSet);
                                }
                                else
                                    self.type.unset();
                            }
                        }

                    }
                },
                FixedSelect:
                    {
                        inherits: 'ComboBox',
                        methods:{
                            getDefaultInputOptions:function()
                            {
                                var self = this;
                                this.dataSource = {
                                    localdata: [],
                                    datatype: "array"
                                };
                                this.dataAdapter = new $.jqx.dataAdapter(self.dataSource);
                                return {
                                    source: this.dataAdapter,
                                    autoBind: true,
                                    displayMember: this.getSearchField(),
                                    valueMember: this.getValueField(),
                                    autoDropDownHeight: true,
                                    width: 200,
                                    height: 25,
                                    placeHolder:Siviglia.issetOr(this.inputParams["placeholder"],null)
                                };
                            }
                        }
                    },
                Relationship:{
                    inherits:'ComboBox'
                },
                Date:{
                    inherits:'BaseInput',
                    methods:
                        {
                            getDefaultInputOptions: function () {
                               return {};
                            },
                            getJqxWidgetName: function () {
                                return "jqxDateTimeInput";
                            },
                            getValue:function()
                            {
                                var val = this.inputNode.jqxDateTimeInput('value');
                                if (val != null)
                                {
                                    var v=val.getMonth()+1;
                                    if(v<10)
                                        v='0'+v;
                                    var d=val.getDate();
                                    if(d<10)
                                        d='0'+d;
                                    var tt= val.getFullYear() + "-" + v + "-" + d;
                                    console.dir(tt);
                                    return tt;
                                }
                                return null;
                            }
                        }
                },
                DateTime:{
                    inherits:'Date',
                    methods:
                        {
                            getValue: function () {
                                var val = this.inputNode.jqxDateTimeInput('value');
                                if (val != null)
                                {
                                    var v=val.getMonth()+1;
                                    if(v<10)
                                        v='0'+v;
                                    var d=val.getDate();
                                    if(d<10)
                                        d='0'+d;
                                    var h=val.getHours();
                                    if(h<10)
                                        h='0'+h;
                                    var m=val.getMinutes();
                                    if(m<10)
                                        m='0'+m;
                                    var s=val.getSeconds();
                                    if(s<10)
                                        s='0'+s;

                                    return val.getFullYear() + "-" + v + "-" + d + " " + h + ":" + m + ":" + s;
                                }
                                return null;
                            }
                        }
                },
                Money:{
                    inherits:'Decimal'
                },
                Password:{
                    inherits:'String'
                },
                State:{
                    inherits:'Enum'
                },
                Name:{
                    inherits:'String'
                },
                Street:{
                    inherits:'String'
                },
                City:{
                    inherits:'String'
                },
                Phone:{
                    inherits:'String'
                },
                UUID:{
                    inherits:'String'
                },
                Dictionary:
                    {
                        inherits:'BaseInput',
                        destruct:function()
                        {

                            if(this.currentWidget)
                                this.currentWidget.destruct();
                            this.currentWidget=null;

                        },
                        methods:
                            {
                                preInitialize:function(params)
                                {
                                    this.title="";
                                    this.hasSimpleType=false;
                                    this.description="";
                                    this.BaseInput$preInitialize(params);
                                    this.currentWidget=null;
                                    this.hasCurrentKey=false;
                                    this.currentKey=null;
                                    this.params=params;
                                },
                                initialize:function(params)
                                {
                                },
                                buildNewItemWidget:function(node,params)
                                {

                                    if(this.newItemWidget) {
                                        this.newItemWidget.destruct();
                                    }
                                    node.html("");
                                    var pp=this.params;
                                    pp.parent=this;
                                    var tempNode=$("<div></div>");
                                    this.newItemWidget=new Siviglia.inputs.jqwidgets.NewItem('Siviglia.inputs.jqwidgets.NewItem',
                                        pp,
                                        {},
                                        tempNode,
                                        this.__context
                                    );
                                    this.newItemWidget.__build()
                                    node.append(tempNode);
                                },
                                onLabelClicked:function(node, params)
                                {
                                    console.log("*****LABEL CLICKED*****");
                                    this.currentKey=params.key;
                                    this.hasCurrentKey=true;

                                },
                                getInputFor:function(node,params)
                                {
                                    if(this.currentWidget!=null) {
                                        this.currentWidget.destruct();
                                        this.currentWidget = null;
                                        node.html("");
                                    }
                                    if(params.key==null)
                                        return;

                                    this.currentWidget=this.__getInputFor(params.key);

                                    node.append(this.currentWidget.rootNode);
                                },
                                __getInputFor:function(key)
                                {
                                    var l;

                                    var factory=new Siviglia.inputs.jqwidgets.Factory()
                                    var instance=factory.getInput(this.type["_"+key],{controller:this.type.controller});

                                    this.curType=this.type["_"+key];
                                    if(this.curType.definition.LAYOUT)
                                        l = this.curType.definition.LAYOUT;
                                    else
                                        l = "Siviglia.inputs.jqwidgets.DefaultLayout";

                                    var s=Siviglia.Utils.stringToContextAndObject(l);

                                    var lay=new s.context[s.object](l,{name:key,input:instance},{},$('<div></div>'),this.__context);
                                    lay.__build();
                                    return lay;

                                },
                                getLabel:function(node,params,event)
                                {
                                    var curKey=params.key;
                                    node.html(this.type.definition.FIELDS[curKey].LABEL || curKey);
                                },
                                onRemoveClicked:function(node,params,event)
                                {
                                    if(params.key==this.currentKey && this.currentWidget!=null)
                                    {
                                        this.currentWidget.destruct();
                                    }
                                    this.hasCurrentKey=false;
                                    this.currentKey=null;
                                    this.currentWidget=null;
                                    var v=this.type.getValue();
                                    delete v[params.key];
                                    //this.type.removeItem(params.key);

                                },
                                onAdd:function(val)
                                {
                                    this.type.addItem(val);
                                    this.onLabelClicked(null,{key:val});
                                },

                            }
                    },
                Container:
                    {
                        inherits:'Dictionary',
                        destruct:function(){

                            for(var k in this.subwidgets)
                                this.subwidgets[k].destruct();
                        },
                        methods: {
                            preInitialize:function(params)
                            {
                                this.subwidgets={};
                                this.Dictionary$preInitialize(params);
                            },
                            getInputFor: function (node, params) {

                                this.subwidgets[params.key]=this.__getInputFor(params.key);
                                node.append(this.subwidgets[params.key].rootNode);
                            }
                        }
                    },
                FixedDictionary:
                    {
                        inherits:'Dictionary',
                        methods: {
                            preInitialize: function (params) {
                                this.BaseInput$preInitialize(params);
                                this.currentWidget = null;
                                this.hasCurrentKey=false;
                                this.currentKey = null;
                            },
                            buildNewItemWidget: function (node, params) {
                                if (this.newItemSelector) {
                                    this.title = "The title";
                                    this.description = "The Description";
                                    this.newItemSelector.destruct();
                                    this.newItemSelector = null;
                                }
                                var uinode = this.params.type;
                                var opts = uinode.getAvailableKeys();

                                if (opts.length > 0) {
                                    var tempType=new Siviglia.types.Enum({
                                        "TYPE":"Enum",
                                        "VALUES":opts
                                    })
                                    var factory=new Siviglia.inputs.jqwidgets.Factory();

                                    this.newItemSelector = factory.getInput(tempType);

                                    var m = this;
                                    this.newItemSelector.on("change", function (ev) {
                                        var curLabel = m.newItemSelector.getValue();
                                        var tt = m.type.getPossibleKeys();
                                        for (var k=0;k<tt.length;k++) {
                                            if (tt[k] == curLabel) {
                                                m.onChangeType(tt[k]);
                                                m.buildNewItemWidget(node, {});
                                            }
                                        }
                                    });
                                    node.append(this.newItemSelector.node);
                                }

                            },
                            onChangeType: function (val) {
                                this.type.addItem(val);
                                this.onLabelClicked(null, {key: val});

                            },
                            onRemoveClicked: function (node, params, event) {
                                this.DictionaryPainter$onRemoveClicked(node, params, event);
                                this.buildNewItemWidget(this.newItemNode);
                            }
                        }

                    },
                Array:
                    {
                        inherits:'BaseInput',
                        methods:
                            {
                                preInitialize:function(params)
                                {
                                    this.BaseInput$preInitialize(params);
                                    this.values=params.type.getValue()
                                },
                                initialize:function(params)
                                {

                                },
                                onRemoveClicked:function(node,params)
                                {
                                    this.type.remove(params.key);
                                },
                                buildNewItemWidget:function(node,params)
                                {
                                    if(this.newItemWidget) {
                                        this.newItemWidget.destruct();
                                    }
                                    node.html("");
                                    if(typeof params=="undefined")
                                        params={};
                                    var pp={parent:this}

                                    var tempNode=$("<div></div>");
                                    this.newItemWidget=new Siviglia.inputs.jqwidgets.NewItem('Siviglia.inputs.jqwidgets.NewItem',
                                        pp,
                                        {},
                                        tempNode,
                                        this.__context
                                    );
                                    this.newItemWidget.__build();
                                    node.append(tempNode);
                                }
                            }
                    },
                ObjectArray: {
                    inherits:'BaseInput',
                    methods: {
                        preInitialize:function(params)
                        {
                            this.BaseInput$preInitialize(params);
                            this.currentWidget=null;
                            this.currentKey=null;
                            this.hasCurrentKey=false;
                            this.keyDirection="HORIZONTAL";

                        },
                        initialize:function(params)
                        {

                            this.nElems=this.type.children.length;
                            this.widgetContainer=$('.currentWidget',this.rootNode);
                        },
                        onLabelClicked:function(node, params)
                        {
                            if(this.currentWidget)
                                this.currentWidget.destruct();
                            this.hasCurrentKey=true;
                            this.currentKey=params.index;
                            var factory=new Siviglia.inputs.jqwidgets.Factory();
                            this.newItemSelector = factory.getInput(tempType);

                            this.currentWidget=this.painterFactory.factory(this.uinode.children[params.index], this.uinode.parent,{});
                            this.widgetContainer.append(this.currentWidget.rootNode);
                        },
                        getLabel:function(node,params,event)
                        {
                            if(typeof this.uinode.definition.VALUELABEL!="undefined")
                                node.html(this.uinode.getValue()[params.index][this.uinode.definition.VALUELABEL]);
                            else
                                node.html(params.index);
                        },
                        onRemoveClicked:function(node,params,event)
                        {
                            this.uinode.removeItem(params.index);
                            if(params.index==this.currentKey)
                            {
                                this.currentWidget.destruct();
                            }
                        },
                        addItem:function(node)
                        {
                            var val=this.uinode.addItem(null);
                            this.onLabelClicked(null,{index:this.uinode.children.length-1});
                        },
                        reload:function(event)
                        {
                            this.nElems=this.uinode.children.length;
                            this.BasePainter$reload(event);
                        }

                    }
                },
                TypeSwitcher: {
                    inherits: 'BaseInput',
                    methods:
                        {
                        preInitialize:function(params){
                            this.BaseInput$preInitialize(params);
                            this.subNode = null;
                            this.currentType = null;
                            // Se crea el objeto enum que son los tipos permitidos.
                            var allTypes=params.type.getAllowedTypes();
                            var source= {
                                "TYPE": "Array",
                                "DATA":allTypes,
                                "LABEL":"LABEL",
                                "VALUE":"VALUE"
                            };
                            this.typeSelector=Siviglia.types.TypeFactory.getType(this,{
                                "TYPE":"String",
                                "SOURCE":source
                            });
                            var currentType=params.type.getCurrentType();
                            if(currentType!==null)
                                this.typeSelector.setValue(currentType);

                        },

                        initialize:function(params)
                        {
                            if(this.typeSelectorWidget) {
                                this.typeSelector.removeListener(this.typeSelectorWidget);

                            }


                            var factory=new Siviglia.inputs.jqwidgets.Factory();
                            this.typeSelectorWidget = factory.getInput(this.typeSelector);
                            var m=this;
                            this.typeSelector.addListener("CHANGE",function(event,params){
                                var val=m.typeSelector.getValue();
                                m.type.setCurrentType(val);
                            })

//                                var curType = m.typeSelectorWidget.getValue();
//



                            this.typeSwitchSelector.append(this.typeSelectorWidget.rootNode);

                        },
                            detach:function()
                            {

                                if(this.typeSelector!==null) {
                                    this.typeSelector.removeListeners(this);

                                }

                            },
                        getTypeFromValue:function(val)
                        {
                            var typeField = Siviglia.issetOr(this.definition.TYPE_FIELD,null);
                            if(typeField!=null)
                                return val[typeField];;

                            for(var ss in this.definition.TYPE_TYPE)
                            {
                                if(val.constructor.toString().match(ss)==ss)
                                    return this.definition.TYPE_TYPE[ss].TYPE;
                            }
                        },
                        getValue: function () {
                            if (this.subNode && !this.subNode.isUnset())
                                return this.subNode.getValue();
                            return null;
                        },
                        save: function () {
                            if (this.subNode && !this.subNode.isUnset())
                                return this.subNode.save();
                            return null;
                        },
                        setType: function (typeName) {
                            if(Siviglia.isset(this.definition.TYPE_FIELD)) {
                                var c = {};
                                c[this.definition.TYPE_FIELD] = typeName;
                            }
                            this.setValue(c);
                        },
                        getAllowedTypes: function () {
                            var result = [];
                            if(Siviglia.isset(this.definition.TYPE_FIELD)) {
                                for (var k = 0; k < this.definition.ALLOWED_TYPES.length; k++) {
                                    var n = this.definition.ALLOWED_TYPES[k];
                                    result.push({LABEL: n, VALUE: n});
                                }
                            }
                            else
                            {
                                for(var ss in this.definition.TYPE_TYPE)
                                {
                                    var cc=this.definition.TYPE_TYPE[ss];
                                    result.push({name:cc.LABEL,value:cc.TYPE});
                                }
                            }
                            return result;
                        },
                        getCurrentType: function () {
                            if (Siviglia.isset(this.receivedValue)) {
                                if(Siviglia.isset(this.definition.TYPE_FIELD)) {
                                    var typeField = this.definition.TYPE_FIELD;
                                    return this.receivedValue[typeField];
                                }
                                else
                                {
                                    for(var ss in this.definition.TYPE_TYPE)
                                    {
                                        var cc=this.definition.TYPE_TYPE[ss];
                                        if(this.receivedValue.constructor.toString().match(ss) != null)
                                            return cc.TYPE;
                                    }
                                }
                            }
                            return this.currentType;
                        },
                        getSubNode: function () {
                            return this.subNode;
                        },
                        __getCurrentPath: function (obj) {
                            if (this.parent == null)return '/ROOT';
                            return this.parent.__getCurrentPath(this);
                        }
                    }

                },
                DefaultLayout:
                    {
                        inherits: "Siviglia.UI.Expando.View",
                        destruct:function()
                        {
                            this.input.destruct();
                        },
                        methods:
                            {
                                preInitialize:function(params)
                                {
                                    this.label=params.name;
                                    this.input=params.input;
                                    if(this.input.type.definition.LABEL)
                                        this.label=this.input.type.definition.LABEL;
                                },
                                initialize:function(params)
                                {
                                    this.inputNode.append(this.input.rootNode)
                                }
                            }
                    },
                NewItem:
                    {
                        inherits:"Siviglia.UI.Expando.View,Siviglia.Dom.EventManager",
                        methods:
                            {
                                preInitialize:function(params)
                                {
                                    this.type=params.type;
                                    this.parent=params.parent;
                                    this.subType=null;
                                    this.subInput=null;
                                    this.params=params;
                                    this.source=null;

                                },
                                initialize:function()
                                {
                                    this.type.addListener("CHANGE",this,"paintInput");
                                    var m=this;
                                    if (this.type.hasSource()) {
                                        var source=this.type.getSource(this.type.controller.view,{});
                                        source.addListener("CHANGE", null, function (ev,data) {
                                            m.paintInput(data?data.data:null);
                                        });
                                        m.source=this;
                                        source.fetch();
                                    }
                                    else
                                        this.paintInput(null);
                                },
                                detach:function()
                                {
                                    this.type.removeListeners(this);
                                    if(this.source)
                                        this.source.removeListeners(this);
                                },
                                paintInput:function(data)
                                {
                                    var factory=new Siviglia.inputs.jqwidgets.Factory();
                                    if(this.subType)
                                        this.subType.destruct();

                                    if(this.subInput)
                                        this.subType.destruct();

                                    if (this.type.hasSource()) {

                                        if(!data)
                                            data=[];
                                        data=this.type.intersect(data);
                                        this.subType=new Siviglia.types.Enum({
                                           "TYPE":"Enum",
                                            "VALUES":data
                                        });
                                    }
                                    else {
                                        this.subType=new Siviglia.types.String({
                                            "TYPE":"String"
                                        });
                                    }
                                    this.subInput=factory.getInput(this.subType,{controller:this.parent.type.controller});
                                    this.inputNode.html('');
                                    this.inputNode.append(this.subInput.rootNode);
                                },
                                onAdd: function () {
                                    this.parent.onAdd(this.subInput.getValue());

                                }
                            }
                    }
            }
        }
    )


</script>

<div style="display:none">
    <div data-sivWidget="Siviglia.inputs.jqwidgets.String" data-widgetParams="type,inputParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.String">
        <input type="text" data-sivId="inputNode"></input>
    </div>
    <div data-sivWidget="Siviglia.inputs.jqwidgets.Enum" data-widgetParams="type,inputParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.Enum">
        <div data-sivId="inputNode"></div>
    </div>
    <div data-sivWidget="Siviglia.inputs.jqwidgets.Integer" data-widgetParams="type,inputParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.Integer">
        <div data-sivId="inputNode"></div>
    </div>
    <div data-sivWidget="Siviglia.inputs.jqwidgets.Decimal" data-widgetParams="type,inputParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.Decimal">
        <div data-sivId="inputNode"></div>
    </div>
    <div data-sivWidget="Siviglia.inputs.jqwidgets.Text" data-widgetParams="type,inputParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.Text">
        <textarea data-sivId="inputNode"></textarea>
    </div>
    <div data-sivWidget="Siviglia.inputs.jqwidgets.Boolean" data-widgetParams="type,inputParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.Boolean">
        <div data-sivId="inputNode"></div>
    </div>
    <div data-sivWidget="Siviglia.inputs.jqwidgets.ComboBox" data-widgetParams="type,inputParams,sourceParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.ComboBox">
        <div data-sivId="inputNode"></div>
    </div>
    <div data-sivWidget="Siviglia.inputs.jqwidgets.FixedSelect" data-widgetParams="type,inputParams,sourceParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.FixedSelect">
        <div data-sivId="inputNode"></div>
    </div>
    <div data-sivWidget="Siviglia.inputs.jqwidgets.Relationship" data-widgetParams="type,inputParams,sourceParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.Relationship">
        <div data-sivId="inputNode"></div>
    </div>
    <div data-sivWidget="Siviglia.inputs.jqwidgets.Date" data-widgetParams="type,inputParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.Date">
        <div data-sivId="inputNode"></div>
    </div>
    <div data-sivWidget="Siviglia.inputs.jqwidgets.Money" data-widgetParams="type,inputParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.Money">
        <div data-sivId="inputNode"></div>
    </div>
    <div data-sivWidget="Siviglia.inputs.jqwidgets.Password" data-widgetParams="type,inputParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.Password">
        <div data-sivId="inputNode"></div>
    </div>
    <div data-sivWidget="Siviglia.inputs.jqwidgets.State" data-widgetParams="type,inputParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.Date">
        <div data-sivId="inputNode"></div>
    </div>
    <div data-sivWidget="Siviglia.inputs.jqwidgets.Name" data-widgetParams="type,inputParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.Date">
        <div data-sivId="inputNode"></div>
    </div>
    <div data-sivWidget="Siviglia.inputs.jqwidgets.Street" data-widgetParams="type,inputParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.Street">
        <div data-sivId="inputNode"></div>
    </div>
    <div data-sivWidget="Siviglia.inputs.jqwidgets.City" data-widgetParams="type,inputParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.City">
        <div data-sivId="inputNode"></div>
    </div>
    <div data-sivWidget="Siviglia.inputs.jqwidgets.Phone" data-widgetParams="type,inputParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.Phone">
        <div data-sivId="inputNode"></div>
    </div>
    <div data-sivWidget="Siviglia.inputs.jqwidgets.UUID" data-widgetParams="type,inputParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.UUID">
        <div data-sivId="inputNode"></div>
    </div>
    <div data-sivWidget="Siviglia.inputs.jqwidgets.DefaultLayout" data-widgetParams="name,input" data-widgetCode="Siviglia.inputs.jqwidgets.DefaultLayout">
        <div class="container">
            <div class="row">
                <div class="col col-sm-2" data-sivValue="/*label"></div>
                <div class="col-sm-10" data-sivId="inputNode"></div>
            </div>
        </div>
    </div>

    <div data-sivWidget="Siviglia.inputs.jqwidgets.Dictionary" data-widgetParams="type,inputParams" data-widgetCode="Siviglia.inputs.jqwidgets.Dictionary"
         class="DictionaryType ContainerType">
        <div class="panel panel-primary">
            <div class="panel-heading" data-sivValue="/*title" class="title"></div>
            <div class="panel-body">
                <!--<div class="container-fluid">-->
                <p class="text-info description" data-sivValue="/*description"></p>
                <div data-sivIf="[%/*hasSimpleType%] == false">

                    <div class="row" style="margin-left:0px">

                        <div style="display:flex">

                            <div class="containerLabel" width="150px">

                                <div class="well">

                                    <ul  class="nav nav-stacked" data-sivLoop="/*type/[[KEYS]]" data-contextIndex="current">

                                        <li role="presentation">
                                            <button class="btn btn-primary" data-sivValue="/@current" data-sivEvent="click" data-sivCallback="onLabelClicked" data-sivParams='{"key":"/@current"}'></button>
                                            <span class="removebutton" style="float:right" data-sivEvent="click" data-sivCallback="onRemoveClicked" data-sivParams='{"key":"/@current"}'></span>
                                        </li>
                                    </ul>
                                </div>
                                <div class="newItemWidget" data-sivCall="buildNewItemWidget"></div>
                            </div>
                            <div data-sivIf="[%/*hasCurrentKey%] == true">
                                <div class="containerInput dictionaryInput">
                                    <div class="currentWidget" data-sivCall="getInputFor" data-sivParams='{"key":"/*currentKey"}'>
                                    </div>
                                </div>
                            </div>

                        </div>

                    </div>
                </div>
                <div data-sivIf="[%/*hasSimpleType%] == true" >
                    POR 2;
                    <div  data-sivLoop="/*type/[[KEYS]]" data-contextIndex="current">

                        <div style="display:flex">
                            <div>
                                <span class="label label-primary" data-sivValue="/@current"></span>
                            </div>
                            <div>
                                <span data-sivCall="getInputFor" data-sivParams='{"key":"/@current-index"}'></span>
                            </div>
                            <div>
                                <span class="removebutton" style="float:right" data-sivEvent="click" data-sivCallback="onRemoveClicked" data-sivParams='{"key":"/@current"}'></span>
                            </div>
                        </div>
                    </div>
                    <div class="newItemWidget" data-sivCall="buildNewItemWidget"></div>
                </div>

                <!--</div>-->
            </div>
            <div class="actions">
                <div class="addItem" data-sivId="newItemNode"></div>
                <div style="float:right" class="saveNode" data-sivId="saveNode">
                    <input type="button" value="Guardar" data-sivEvent="click" data-sivCallback="doSave">
                </div>
                <div style="clear:both"></div>
            </div>
        </div>
    </div>
<!--
    ----------------------------------------------------------------------------------------
-->
    <div data-sivWidget="Siviglia.inputs.jqwidgets.Container" data-widgetParams="type,inputParams" data-widgetCode="Siviglia.inputs.jqwidgets.Container"
         class="ContainerType">
        <div class="panel panel-primary">
            <!--<div class="panel-heading" data-sivValue="/*title" class="title"></div>-->
            <div class="panel-body">
                <p class="text-info description" data-sivValue="/*description"></p>
                <div class="inputs container" data-sivLoop="/*type/definition/FIELDS" data-contextIndex="current">
                    <div class="row">
                        <div class="col col-sm-1 col-md-1">
                            <span sivvalue="/@current-index">aaaa</span>
                            <label class="text-primary"  class="control-label" data-sivCall="getLabel" data-sivParams='{"key":"/@current-index"}'></label>
                        </div>
                        <div class="col col-sm-11 col-md-11">

                                <div data-sivCall="getInputFor" data-sivParams='{"key":"/@current-index"}'></div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<!--
    --------------------------------------------------------------------------------------------
-->


        <div data-sivWidget="Siviglia.inputs.jqwidgets.FixedDictionary" data-widgetParams="type,inputParams" data-widgetCode="Siviglia.inputs.jqwidgets.FixedDictionary"
             class="DictionaryType ContainerType">
            <div class="panel panel-primary">
                <div class="panel-heading" data-sivValue="/*title" class="title"></div>
                <div class="panel-body">
                    <p class="text-info description" data-sivValue="/*description"></p>

                    <div class="row" style="margin-bottom:10px;margin-left:0px">
                        <div class="containerLabel well" style="margin-right:5px">

                            <ul  class="nav nav-stacked" data-sivLoop="/*type/getKeys" data-contextIndex="current">
                                <li role="presentation">
                                    <button class="btn btn-primary" data-sivValue="/@current" data-sivEvent="click" data-sivCallback="onLabelClicked" data-sivParams='{"key":"/@current"}'></button>
                                    <span class="removebutton" style="float:right" data-sivEvent="click" data-sivCallback="onRemoveClicked" data-sivParams='{"key":"/@current"}'></span>
                                </li>
                            </ul>

                            <div class="newItemWidget" data-sivId="newItemNode" data-sivCall="buildNewItemWidget" ></div>
                        </div>
                        <div class="containerInput dictionaryInput" style="padding-right:10px;padding-left:10px">
                            <div class="currentWidget" data-sivCall="getInputFor" data-sivParams='{"key":"/*currentKey"}'>
                            </div>
                        </div>
                    </div>

                    <div class="actions">
                        <div class="addItem" data-sivId="newItemNode"></div>
                        <div style="clear:both"></div>
                    </div>
                </div>

            </div>
        </div>
<!--
    ------------------------------------------------------------------------------------------------------
    -->

            <div data-sivWidget="Siviglia.inputs.jqwidgets.Array" data-widgetParams="parentObject,parentNode,value" data-widgetCode="Siviglia.inputs.jqwidgets.Array" class="ArrayType">
                <p class="text-info description" data-sivValue="/*description"></p>

                <div data-sivLoop="/*type/children" data-contextIndex="current" class="arrayValues" style="min-height:20px;margin-bottom:5px">
                    <span class="label label-primary" style="margin-right:4px;font-size:14px">
                        <span data-sivValue="/@current/value"></span>
                        <span class="remove ion-close-circled " style="color:red;padding-left:5px" data-sivEvent="click" data-sivCallback="onRemoveClicked" data-sivParams='{"key":"/@current"}'></span>
                    </span>
                </div>

                <div data-sivCall="buildNewItemWidget"></div>
            </div>
    <!--
    ------------------------------------------------------------------------------------------------------
    -->
                <div data-sivWidget="Siviglia.inputs.jqwidgets.ObjectArray" data-widgetParams="parentObject,parentNode,value" data-widgetCode="Siviglia.inputs.jqwidgets.ObjectArray" class="ArrayType">
                    <p class="text-info description" data-sivValue="/*description"></p>
                    <div class="row" style="margin-left:0px">

                        <div data-sivIf="[%/*keyDirection%] == VERTICAL">
                            <div style="display:flex">
                                <div class="well">
                                    <ul  class="nav nav-stacked" data-sivLoop="/*type/children" data-contextIndex="current">
                                        <li role="presentation">
                                            <button class="btn btn-primary" data-sivCall="getLabel" data-sivValue="/@current" data-sivEvent="click" data-sivCallback="onLabelClicked" data-sivParams='{"index":"/@current-index"}'></button>
                                            <span class="removebutton" style="float:right" data-sivEvent="click" data-sivCallback="onRemoveClicked" data-sivParams='{"key":"/@current-index"}'></span>
                                        </li>
                                    </ul>
                                    <div class="newItemWidget" data-sivId="newItemNode">
                                        <input type="button" data-sivEvent="click" data-sivCallback="addItem">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div data-sivIf="[%/*keyDirection%] == HORIZONTAL">
                            <div>
                                <span class="newItemWidget add" data-sivId="newItemNode" data-sivEvent="click" data-sivCallback="addItem">
                                </span>
                                <span  data-sivLoop="/*type/children" data-contextIndex="current">
                                    <span class="label label-primary" style="display:inline-block;margin-right:4px;font-size:14px">
                                        <span data-sivCall="getLabel"  data-sivEvent="click" data-sivCallback="onLabelClicked" data-sivParams='{"index":"/@current-index"}'></span>
                                        <span class="removebutton" data-sivEvent="click" data-sivCallback="onRemoveClicked" data-sivParams='{"key":"/@current-index"}'></span>
                                    </span>
                                </span>
                            </div>
                        </div>
                        <div class="containerInput dictionaryInput">
                            <div class="currentWidget">
                            </div>
                        </div>

                    </div>
                </div>
    <!--
        ---------------------------------------------------------------------------------------------
        -->
    <div data-sivWidget="Siviglia.inputs.jqwidgets.TypeSwitcher" data-widgetParams="parentObject,parentNode,value" data-widgetCode="Siviglia.inputs.jqwidgets.TypeSwitcher" class="TypeSwitchType">
        <div class="panel panel-primary">
            <div class="panel-body">
                <div data-sivId="fieldContainer"></div>
                <div class="typeChanger">
                    <div data-sivId="typeSwitchSelector">
                    </div>
                </div>
            </div>

        </div>
    </div>
     <!--
            ---------------------------------------------------------------------------------------
            -->
    <div data-sivWidget="Siviglia.inputs.jqwidgets.NewItem" data-widgetParams="parentObject,parentNode" data-widgetCode="Siviglia.inputs.jqwidgets.NewItem" class="NewItem">
            <div style="display:table-row">
                <div style="display:table-cell" data-sivId="inputNode">
                </div>
                <div style="display:table-cell;vertical-align: top;line-height: 1.0;font-size: 20px;"><div data-sivEvent="click" data-sivCallback="onAdd" class="add"></div></div>
            </div>
    </div>
    <!--
    <div data-sivWidget="AUTOPAINTER_TypeSwitcher" data-widgetParams="parentObject,parentNode" data-widgetCode="Siviglia.AutoUI.Painter.TypeSwitchPainter" class="TypeSwitchType">
        <div class="panel panel-primary">

            <div class="panel-body">
                <div data-sivId="fieldContainer"></div>
                <div class="typeChanger">
                    <div data-sivId="typeSwitchSelector">
                    </div>
                </div>
            </div>

        </div>
    </div>
-->

</div>

